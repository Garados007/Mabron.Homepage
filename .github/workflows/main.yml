name: Mabron Publish

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      
      - name: install deps
        run: sudo apt-get install -y wget rsync ssh
      
      # - name: create output
      #   run: mkdir -p publish
        
      - name: build site
        run: chmod +x build.sh && ./build.sh
        
      - name: 'Build Zola' 
        uses: shalzz/zola-deploy-action@master
        env:
          BUILD_DIR: .
          BUILD_FLAGS: --output-dir publish --base-url https://mabron.de/
          BUILD_ONLY: true

      # - name: run worker script
      #   run: |
      #     wget https://mabron.de/updater/upload.hash.sh -O upload.sh
      #     chmod +x upload.sh
      #     cd publish
      #     ../upload.sh -u "https://mabron.de/updater/" -d "www.mabron.de" -p "" \
      #       -t ${{ secrets.MABRON_UPDATE_TOKEN }}

      - name: Sync with Rsync
        run: |
          cd publish
          echo "Setting up SSH"
          mkdir ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 0400 ~/.ssh/id_rsa
          echo -e "StrictHostKeyChecking no\nHost host\n\tHostName ssh.strato.de\n\tUser mabron.de\n\tIdentityFile ~/.ssh/id_rsa" > ~/.ssh/config
          echo "Load rsync filters"
          rsync -avzm --filter="+ */" --filter="+ .filter" --filter="- *" host:~/webroot/www/ .
          echo "Upload files"
          rsync -avz --dry-run --delete --filter=". .filter" . host:~/webroot/www/
          echo "Cleanup"
          rm -r ~/.ssh
